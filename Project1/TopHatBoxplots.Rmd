---
title: "World Financial Indices"
author: "Victor Cruz Diaz, Brooks Lybrand, and Saeed Hashmi"
resource_files:
- .Renviron
- .Renviron
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---
This is an R Interactive Document, which uses the [R Markdown](http://rmarkdown.rstudio.com/authoring_basics.html) language to generate HTML. For a brief introduction to R Markdown, please review this [video](https://www.youtube.com/watch?v=DNS7i2m4sB0&feature=youtu.be).

#Load Packages
This [code chunk](http://rmarkdown.rstudio.com/authoring_rcodechunks.html) loads the packages required to run the R code in the document.
The last line of this code chunk enables document caching, which is expalined at this [link](http://rmarkdown.rstudio.com/authoring_rcodechunks.html).

```{r setup, echo=FALSE}
library(tidyverse)
library(data.world)
library(DT)
library(plotly)
library(lubridate)
knitr::opts_chunk$set(echo = TRUE)
```

#Display Session Information
The [sessionInfo() fuction](https://cran.r-project.org/web/packages/sessioninfo/sessioninfo.pdf) queries and prints information about the current R session including  information about packages, and from where they were installed.
```{r}
sessionInfo()
```

#Retrieve countries from the financial indices dataset
The following query retrieves the distinct country names from the financial indices dataset at data.world and saves the country names in the country variable.
```{r}
project <- "https://data.world/cruzdiaz-victor/s18-edv-project-1-dataset"
data.world::set_config(cfg_env("DW_API")) 
countries <- data.world::query(data.world::qry_sql(
 "   
	select distinct country_name
	from cleaned_data 
 "),
dataset = project)
indices <- data.world::query(data.world::qry_sql(
 "   
	select distinct indicator_name
	from cleaned_data 
 "),
dataset = project)
```


#Create Panel with Select List and Slider
The following code creates an input panel for the Interactive Document, which has a [select box](https://shiny.rstudio.com/reference/shiny/latest/selectInput.html) for selecting regions (notice - choices is set to the regions variable that was loaded by the previous query), and a [slider](https://shiny.rstudio.com/reference/shiny/latest/sliderInput.html) that will be used when querying the database for the sales data. For a complete list of Shiny function, please see this [link](https://shiny.rstudio.com/reference/shiny/latest/).

```{r}
inputPanel(
  selectInput("selectcountry_1", label = "Select Country",choices = countries, multiple=TRUE, selected=c("United States", "Mexico")),
  selectInput("selectindex_1", label = "Select Index",choices = indices, multiple=TRUE, selected=c("Financial Development Index", "Financial Institutions Access Index")),
  sliderInput("selectyear_1", label = "Year:", min = 1980, max = 2014, value = c(1980, 2014), step = 1)
)
```

#Create Dataframe with region, category, sales, and order_date data
The following Shiny [eventReactive](https://shiny.rstudio.com/reference/shiny/1.0.1/observeEvent.html) code runs a query that retrieves the region, category, and sales data from the SuperStore database at data.world and saves it in the df variable as a function that returns an R dataframe. This is an example of a data.world parameterized query; details for data.world queries can be found at this [link](https://cran.r-project.org/web/packages/data.world/vignettes/query.html). The "?"s in the query are parameters. The parameters are filled in (in order) by the paramQuery$params statement.

####Look up syntax and fix paramquery...
```{r}
df <- eventReactive(c(input$selectcountry_1, input$selectindex_1, input$selectyear_1), {
  project <- "https://data.world/cruzdiaz-victor/s18-edv-project-1-dataset" 
  data.world::set_config(cfg_env("DW_API")) 
  paramQuery <- data.world::qry_sql(
    paste(
      "
  	    select country_name, country_code, indicator_name, indicator_code, values, year
        from cleaned_data c
        where cast(year as integer) between
      ", input$selectyear_1[1], "and", input$selectyear_1[2],
      "and country_name in (", paste("\"", paste(input$selectcountry_1, collapse="\", \""), "\"", sep=""), ")",
      "and indicator_name in (", paste("\"", paste(input$selectindex_1, collapse="\", \""), "\"", sep=""), ")"
    )
   )
  data.world::query(paramQuery, dataset = project)
})
```
#Create a Countries Variable
Create a Countries variable with a string constructed from the selected regions in the input$selectRegion_1 variable.This Countries variable will be used in the title of the ggplot below.

```{r}
Countries <- eventReactive(c(input$selectcountry_1), { 
  library('stringr')
  str_c(input$countries, collapse=', ')
})
```

#Display the Dataframe as a Table
The following code uses the [DT package's](https://rstudio.github.io/DT/) datatable function to render the dataframe in the df variable as a table. Notice the need to use df() and not df in the function because df contains a function that returns the dataframe.

The [dplyr::mutate() function](http://dplyr.tidyverse.org/reference/mutate.html) is used to add a "quarter" column to the dataframe before it is displayed.

```{r}
# Notice the need to use df1() below:
renderDataTable({
  # DT::datatable(df() %>% dplyr::mutate(year = lubridate:year(order_date)), rownames = FALSE,
  DT::datatable(df(), rownames = FALSE, extensions = list(Responsive = TRUE, FixedHeader = TRUE))
})
```

#Display the data in a Boxplot

Using [ggplotly](https://www.rdocumentation.org/packages/plotly/versions/4.7.1/topics/ggplotly)

```{r}
tabsetPanel( 
  tabPanel("Year:",
    numericInput("year_1","Year:",1994)),
  tabPanel("Data for logan",
    textInput("title_1", "Title", "Data for logan "),
    numericInput("titleFont_1", "Title Font", 10)), 
  tabPanel("Axis Labels",
    textInput("xLabel_1", "x-Axis Label", "Country Name"),
    textInput("yLabel_1", "y-Axis Label", "Index Value"),
    numericInput("textFont_1", "textFont:", 10)))

```

```{r}
df1 <- eventReactive(c(input$selectcountry_1))
```

```{r}
# Boxplot - see http://ggplot2.tidyverse.org/reference/geom_boxplot.html
# Notice the need to use df(), and Countries() below: 
renderPlotly({
  plot = df1() %>% ggplot() + 
    geom_boxplot(mapping = aes(x = input$selectindex_1 , y= input$selectyear_1,25)) +
     
    theme(plot.title = element_text(size = input$titleFont_1, face = "bold")) + 
    
    theme(axis.text=element_text(size=input$textFont_1),
          axis.title=element_text(size=input$textFont_1, face="bold"),
          axis.text.x = element_text(angle = 90, hjust = 1))  +
    theme(plot.margin=unit(c(2,1,1,1),"cm")) +
    scale_y_continuous(labels = scales::comma) + # Disable scientific notation
    ggtitle(paste(input$selectcountry_1, input$title_1)) +
    xlab(input$xLabel_1) + ylab(input$yLabel_1)
  ggplotly(plot, tooltip = c("selectindex_1"), session="knitr", width = input$plotWidth_2, height = input$plotHeight_2)
})
```


